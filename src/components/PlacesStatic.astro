---
import PlaceStatic from './PlaceStatic.astro';
import FilterBar from './FilterBarStatic.astro';

const ALLOWED_TYPES = [
  'art_gallery',
  'cafe',
  'library',
  'museum',
  'hotel',
  'coffee_shop',
  'performing_arts_theater'
];

// Helper function to generate random additional info
const generateRandomAdditionalInfo = () => {
  return {
    userScore: Math.floor(Math.random() * 100),
    wifiPassword: Math.random().toString(36).substring(2, 10),
    wifiSpeed: Math.floor(Math.random() * 200) + 1,
    wifiSSID: `WiFi_Network_${Math.floor(Math.random() * 1000)}`, // Add this line
    socketsAvailable: Math.random() < 0.7,
    wifiUpdated: new Date(Date.now() - Math.floor(Math.random() * 30 * 24 * 60 * 60 * 1000)).toISOString()
  };
};

const samplePlaces = [
  {
    id: 'place1',
    displayName: { text: 'Cozy Corner Café' },
    primaryType: 'cafe',
    primaryTypeDisplayName: { text: 'Café' },
    rating: 4.5,
    distance: 500,
    formattedAddress: '123 Coffee St, Brew City, Beanland',
    photos: [{ url: 'https://images.unsplash.com/photo-1501339847302-ac426a4a7cbb?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1000&q=80' }],
    types: ['cafe', 'restaurant', 'food'],
    userRatingCount: 100,
    score: 0.9,
    editorialSummary: { text: 'A cozy café with artisanal coffee and freshly baked pastries.' },
    websiteUri: 'https://cozycornercafe.com',
    additionalInfo: generateRandomAdditionalInfo(),
    tags: ['Great Wi-Fi', 'Comfy', 'Great coffee', 'Good Vibes']
  },
  {
    id: 'place2',
    displayName: { text: 'Modern Masterpieces Gallery' },
    primaryType: 'art_gallery',
    primaryTypeDisplayName: { text: 'Art Gallery' },
    rating: 4.2,
    distance: 1200,
    formattedAddress: '456 Palette Rd, Art City, Creativia',
    photos: [{ url: 'https://images.unsplash.com/photo-1545033131-485ea67fd7c3?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1000&q=80' }],
    types: ['art_gallery', 'museum'],
    userRatingCount: 80,
    score: 0.85,
    editorialSummary: { text: 'A contemporary art gallery showcasing works from emerging local artists.' },
    websiteUri: 'https://modernmasterpiecesgallery.com',
    additionalInfo: generateRandomAdditionalInfo(),
    tags: ['Spacious', 'Quiet', 'Good Vibes']
  },
  {
    id: 'place3',
    displayName: { text: 'Tranquil Tomes Library' },
    primaryType: 'library',
    primaryTypeDisplayName: { text: 'Library' },
    rating: 4.8,
    distance: 800,
    formattedAddress: '789 Bookworm Ln, Read Town, Literaria',
    photos: [{ url: 'https://images.unsplash.com/photo-1521587760476-6c12a4b040da?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1000&q=80' }],
    types: ['library', 'book_store'],
    userRatingCount: 120,
    score: 0.95,
    editorialSummary: { text: 'A serene library with an extensive collection of books and quiet reading nooks.' },
    websiteUri: 'https://tranquiltomeslibrary.com',
    additionalInfo: generateRandomAdditionalInfo(),
    tags: ['Quiet', 'Spacious', 'Great Wi-Fi', 'Outlets']
  },
  {
    id: 'place4',
    displayName: { text: 'Historic Heritage Museum' },
    primaryType: 'museum',
    primaryTypeDisplayName: { text: 'Museum' },
    rating: 4.6,
    distance: 1500,
    formattedAddress: '101 Artifact Ave, Antiquity City, Historyland',
    photos: [{ url: 'https://images.unsplash.com/photo-1566127992631-137a642a90f4?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1000&q=80' }],
    types: ['museum', 'tourist_attraction'],
    userRatingCount: 200,
    score: 0.92,
    editorialSummary: { text: 'An immersive museum showcasing the rich history and cultural heritage of the region.' },
    websiteUri: 'https://historicheritagemmuseum.com',
    additionalInfo: generateRandomAdditionalInfo(),
    tags: ['Spacious', 'Quiet', 'Good Vibes']
  },
  {
    id: 'place5',
    displayName: { text: 'Luxe Skyline Hotel' },
    primaryType: 'hotel',
    primaryTypeDisplayName: { text: 'Hotel' },
    rating: 4.7,
    distance: 2000,
    formattedAddress: '555 Comfort Plaza, Skyview City, Hospitaland',
    photos: [{ url: 'https://images.unsplash.com/photo-1566073771259-6a8506099945?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=1000&q=80' }],
    types: ['hotel', 'lodging'],
    userRatingCount: 300,
    score: 0.94,
    editorialSummary: { text: 'A luxurious hotel offering stunning city views and world-class amenities.' },
    websiteUri: 'https://luxeskylinehotel.com',
    additionalInfo: generateRandomAdditionalInfo(),
    tags: ['Great Wi-Fi', 'Comfy', 'Friendly', 'Tasty food']
  }
];

const userLocation = { lat: 40.7128, lng: -74.0060 };
---

<div>
  {Astro.props.env === 'development' && (
    <button 
      class="mb-4 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600"
    >
      Clear Places Cache
    </button>
  )}
  
  <FilterBar />
  
  <div id="places-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    {samplePlaces.length === 0 && <p>No places found.</p>}
    {samplePlaces.map(place => (
      <div class="place-item">
        <PlaceStatic place={place} />
      </div>
    ))}
  </div>
</div>

<!-- Add this just before the closing </div> tag of the main component -->
<div id="modal-container" class="fixed inset-0 z-50 hidden">
  <div id="modal-overlay" class="absolute inset-0 bg-black opacity-0"></div>
</div>

<script>
  import { animate } from 'framer-motion/dom';

  document.addEventListener('DOMContentLoaded', () => {
    const placeItems = document.querySelectorAll('.place-item');
    let modalContainer = document.getElementById('modal-container');
    let modalOverlay = document.getElementById('modal-overlay');

    // Create modal elements if they don't exist
    if (!modalContainer) {
      modalContainer = document.createElement('div');
      modalContainer.id = 'modal-container';
      modalContainer.className = 'fixed inset-0 z-50 hidden';
      document.body.appendChild(modalContainer);
    }

    if (!modalOverlay) {
      modalOverlay = document.createElement('div');
      modalOverlay.id = 'modal-overlay';
      modalOverlay.className = 'absolute inset-0 bg-black opacity-0';
      modalContainer.appendChild(modalOverlay);
    }

    let activeItem = null;
    let activeClone = null;

    function closeModal() {
      if (!activeClone) return;

      animate(activeClone, 
        { opacity: 0, scale: 0.9 },
        { duration: 0.3, ease: 'easeIn' }
      ).then(() => {
        document.body.removeChild(activeClone);
        activeItem = null;
        activeClone = null;
      });

      animate(modalOverlay, { opacity: 0 }, { duration: 0.3 }).then(() => {
        modalContainer.style.display = 'none';
      });
    }

    placeItems.forEach(item => {
      item.addEventListener('click', () => {
        if (activeItem) return; // Prevent clicking while modal is open

        activeItem = item;
        const itemRect = item.getBoundingClientRect();
        const itemClone = item.cloneNode(true);

        // Style the clone to match the original item's position
        itemClone.style.position = 'fixed';
        itemClone.style.top = `${itemRect.top}px`;
        itemClone.style.left = `${itemRect.left}px`;
        itemClone.style.width = `${itemRect.width}px`;
        itemClone.style.height = `${itemRect.height}px`;
        itemClone.style.margin = '0';
        itemClone.style.zIndex = '100';

        document.body.appendChild(itemClone);
        activeClone = itemClone;

        // Animate the clone to center and expand
        animate(itemClone, {
          top: '50%',
          left: '50%',
          x: '-50%',
          y: '-50%',
          width: '90vw',
          maxWidth: '400px',
          scale: 1,
        }, { duration: 0.3, ease: 'easeInOut' });

        // Show and animate the modal container
        modalContainer.style.display = 'block';
        animate(modalOverlay, { opacity: 0.5 }, { duration: 0.3 });
      });
    });

    // Close modal when clicking outside
    modalContainer.addEventListener('click', (event) => {
      if (event.target === modalContainer || event.target === modalOverlay) {
        closeModal();
      }
    });

    // Initial animation for place items
    placeItems.forEach((item, index) => {
      animate(item, 
        { opacity: [0, 1], y: [50, 0] },
        { duration: 0.5, delay: index * 0.1 }
      );
    });
  });
</script>